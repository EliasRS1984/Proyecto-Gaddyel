# ๐ Diagrama de Flujo - Checkout Protegido

## Flujo Visual del Sistema

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     USUARIO INICIA COMPRA                            โ
โ                   (Agrega productos al carrito)                      โ
โโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                      โ
                      โผ
              โโโโโโโโโโโโโโโโโ
              โ Clic "Ir a    โ
              โ    Pagar"     โ
              โโโโโโโโโฌโโโโโโโโ
                      โ
                      โผ
         โโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ  ยฟUsuario autenticado? โ
         โโโโโโฌโโโโโโโโโโโโโโโฌโโโโโ
              โ              โ
         NO   โ              โ   Sร
              โ              โ
              โผ              โผ
    โโโโโโโโโโโโโโโโโโโ   โโโโโโโโโโโโโโโโโโโโโโโโ
    โ REDIRIGIR A     โ   โ MOSTRAR CHECKOUT     โ
    โ   /login        โ   โ  (datos precargados) โ
    โโโโโโฌโโโโโโโโโโโโโ   โโโโโโโโฌโโโโโโโโโโโโโโโโ
         โ                       โ
         โผ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโ     โ
    โ Mensaje:            โ     โ
    โ "๐ Necesitas       โ     โ
    โ iniciar sesiรณn      โ     โ
    โ para continuar"     โ     โ
    โโโโโโฌโโโโโโโโโโโโโโโโโ     โ
         โ                       โ
         โผ                       โ
    โโโโโโโโโโโโโโโโโโโโโโโ     โ
    โ Opciones:           โ     โ
    โ 1. Login            โ     โ
    โ 2. Registro         โ     โ
    โโโโโโฌโโโโโโโโโโโโโโโโโ     โ
         โ                       โ
    โโโโโโดโโโโโ                 โ
    โ Login / โ                 โ
    โ Registroโ                 โ
    โ Exitoso โ                 โ
    โโโโโโฌโโโโโ                 โ
         โ                       โ
         โโโโโโโโโโโโโฌโโโโโโโโโโโโ
                     โ
                     โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ   PรGINA CHECKOUT      โ
        โ                        โ
        โ โข Nombre (readonly)    โ
        โ โข Email (readonly)     โ
        โ โข WhatsApp (readonly)  โ
        โ                        โ
        โ โโโโโโโโโโโโโโโโโโโโโโโ
        โ โ Direcciรณn de envรญo โโ
        โ โ [Cambiar direcciรณn]โโ
        โ โโโโโโโโโโโโโโโโโโโโโโโ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโ
        โ ยฟUsuario edita     โ
        โ    direcciรณn?      โ
        โโโโโโฌโโโโโโโโโโโฌโโโโโ
             โ          โ
         Sร  โ          โ  NO
             โ          โ
             โผ          โ
    โโโโโโโโโโโโโโโโ   โ
    โ MOSTRAR      โ   โ
    โ FORMULARIO   โ   โ
    โ              โ   โ
    โ โข Domicilio  โ   โ
    โ โข Localidad  โ   โ
    โ โข Provincia  โ   โ
    โ โข Cรณd. Postalโ   โ
    โโโโโโโโฌโโโโโโโโ   โ
           โ           โ
           โโโโโโโฌโโโโโโ
                 โ
                 โผ
        โโโโโโโโโโโโโโโโโโโโโโ
        โ Usuario confirma   โ
        โ     pedido         โ
        โโโโโโโโโโฌโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        FRONTEND: Checkout.jsx                      โ
โ                                                    โ
โ  1. Detectar cambios en direcciรณn                 โ
โ     if (domicilio !== cliente.domicilio || ...)   โ
โ                                                    โ
โ  2. Actualizar perfil (async)                     โ
โ     await actualizarPerfil(newAddress)            โ
โ     โ                                              โ
โ     โโ AuthContext.actualizarPerfil()             โ
โ        โโ authService.actualizarPerfil()          โ
โ           โโ PUT /api/auth/perfil                 โ
โ                                                    โ
โ  3. Crear orden                                   โ
โ     await createOrder(checkoutData, cartItems)    โ
โ                                                    โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        BACKEND: orderController.js                 โ
โ                                                    โ
โ  1. Validar productos y stock                     โ
โ  2. Calcular costos (subtotal + envรญo)            โ
โ                                                    โ
โ  3. Buscar/Crear cliente                          โ
โ     if (clienteId) {                              โ
โ       clienteDoc = await Client.findById()        โ
โ                                                    โ
โ  4. Actualizar datos del cliente en BD            โ
โ     clienteDoc.domicilio = clienteData.domicilio  โ
โ     clienteDoc.localidad = clienteData.localidad  โ
โ     clienteDoc.provincia = clienteData.provincia  โ
โ     await clienteDoc.save()                       โ
โ     }                                              โ
โ                                                    โ
โ  5. Crear documento Order en MongoDB              โ
โ  6. Generar nรบmero de orden                       โ
โ  7. Devolver ordenId al frontend                  โ
โ                                                    โ
โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        FRONTEND: Orden Confirmada                  โ
โ                                                    โ
โ  โข Limpiar carrito                                โ
โ  โข Guardar datos de orden en localStorage         โ
โ  โข Navegar a /pedido-confirmado/:id               โ
โ                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Sincronizaciรณn de Datos de Perfil

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              CAMBIO DE DIRECCIรN EN CHECKOUT                โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ Usuario edita:             โ
        โ โข Domicilio: "Av. 123"     โ
        โ โข Localidad: "Buenos Aires"โ
        โ โข Provincia: "CABA"        โ
        โ โข CP: "1234"               โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ SINCRONIZACIรN DOBLE               โ
    โ                                    โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ โ 1. Frontend โ AuthContext     โโ
    โ โ    actualizarPerfil()          โโ
    โ โ    โ                           โโ
    โ โ    PUT /api/auth/perfil        โโ
    โ โ    โ                           โโ
    โ โ    โ localStorage.clientData  โโ
    โ โ    โ Context state            โโ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ                                    โ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ โ 2. Backend โ orderController  โโ
    โ โ    Al crear orden:             โโ
    โ โ    โ                           โโ
    โ โ    Client.findById()           โโ
    โ โ    โ                           โโ
    โ โ    client.domicilio = nuevo    โโ
    โ โ    client.save()               โโ
    โ โ    โ                           โโ
    โ โ    โ MongoDB actualizado      โโ
    โ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                 โ
                 โผ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
    โ RESULTADO:                     โ
    โ                                โ
    โ โ localStorage actualizado    โ
    โ โ Context state actualizado   โ
    โ โ MongoDB actualizado          โ
    โ                                โ
    โ Prรณximo checkout mostrarรก      โ
    โ automรกticamente la nueva       โ
    โ direcciรณn                      โ
    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Protecciรณn de Rutas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           App.jsx - Configuraciรณn de Rutas       โ
โโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                     โ
                     โผ
        โโโโโโโโโโโโโโโโโโโโโโโโโโ
        โ <Routes>               โ
        โ   <Route path="/" />   โ
        โ   <Route path="/login" โ
        โ          />            โ
        โ                        โ
        โ   โโโโโโโโโโโโโโโโโโ โ
        โ   RUTAS PROTEGIDAS:   โ
        โ   โโโโโโโโโโโโโโโโโโ โ
        โ                        โ
        โ   <Route element={     โ
        โ     <ProtectedRoute /> โ
        โ   }>                   โ
        โ     <Route path=       โ
        โ       "/checkout" />   โ
        โ   </Route>             โ
        โ </Routes>              โ
        โโโโโโโโโโฌโโโโโโโโโโโโโโโโ
                 โ
                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ        ProtectedRoute.jsx                          โ
โ                                                    โ
โ  const { isAuthenticated, isLoading } =           โ
โ         useContext(AuthContext)                   โ
โ                                                    โ
โ  if (isLoading) {                                 โ
โ    return <LoadingSpinner />                      โ
โ  }                                                 โ
โ                                                    โ
โ  if (!isAuthenticated) {                          โ
โ    return <Navigate to="/login"                   โ
โ              state={{ from: location }} />        โ
โ  }                                                 โ
โ                                                    โ
โ  return <Outlet /> // Renderiza checkout         โ
โ                                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Estados del Sistema

### Estado 1: Usuario No Autenticado
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ localStorage                    โ
โ โโ clientToken: โ null         โ
โ โโ clientData: โ null          โ
โ                                 โ
โ AuthContext                     โ
โ โโ isAuthenticated: false       โ
โ โโ isLoading: false             โ
โ โโ cliente: null                โ
โ                                 โ
โ Acceso a /checkout: โ DENEGADO โ
โ Redirige a: /login              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

### Estado 2: Usuario Autenticado
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ localStorage                                โ
โ โโ clientToken: โ "jwt-token-here"        โ
โ โโ clientData: โ { nombre, email, ... }   โ
โ                                             โ
โ AuthContext                                 โ
โ โโ isAuthenticated: true                   โ
โ โโ isLoading: false                        โ
โ โโ cliente: {                              โ
โ      _id: "123...",                         โ
โ      nombre: "Juan Pรฉrez",                  โ
โ      email: "juan@mail.com",                โ
โ      domicilio: "Av. Principal 123",        โ
โ      localidad: "Buenos Aires",             โ
โ      provincia: "CABA"                      โ
โ    }                                        โ
โ                                             โ
โ Acceso a /checkout: โ PERMITIDO           โ
โ Datos precargados: โ Sร                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## Secuencia de Sincronizaciรณn (Diagrama Temporal)

```
TIEMPO โ

Frontend          Backend             MongoDB
   โ                 โ                   โ
   โ 1. Usuario      โ                   โ
   โ    edita        โ                   โ
   โ    direcciรณn    โ                   โ
   โ                 โ                   โ
   โ 2. Confirma     โ                   โ
   โ    pedido       โ                   โ
   โ                 โ                   โ
   โโโPUT /api/      โ                   โ
   โ   auth/perfilโโโโ                   โ
   โ                 โ                   โ
   โ                 โโUPDATE clienteโโโโโ
   โ                 โ   SET domicilio   โ
   โ                 โ                   โ
   โ                 โโโโโโโOKโโโโโโโโโโโโค
   โ                 โ                   โ
   โโโโ200 OKโโโโโโโโโค                   โ
   โ { cliente: {..} โ                   โ
   โ                 โ                   โ
   โ 3. Actualizar   โ                   โ
   โ    localStorage โ                   โ
   โ    โ           โ                   โ
   โ                 โ                   โ
   โ 4. Actualizar   โ                   โ
   โ    Context      โ                   โ
   โ    โ           โ                   โ
   โ                 โ                   โ
   โโโPOST /api/     โ                   โ
   โ   pedidos/crearโโ                   โ
   โ                 โ                   โ
   โ                 โโFIND clienteโโโโโโโ
   โ                 โ                   โ
   โ                 โโโโโโโclienteโโโโโโโค
   โ                 โ                   โ
   โ                 โโUPDATE clienteโโโโโ
   โ                 โ   (reconfirmar    โ
   โ                 โ    direcciรณn)     โ
   โ                 โ                   โ
   โ                 โโCREATE orderโโโโโโโ
   โ                 โ                   โ
   โ                 โโโโโโโOKโโโโโโโโโโโโค
   โ                 โ                   โ
   โโโโ200 OKโโโโโโโโโค                   โ
   โ { ordenId: ".."}โ                   โ
   โ                 โ                   โ
   โ 5. Navigate     โ                   โ
   โ    /pedido-     โ                   โ
   โ    confirmado   โ                   โ
   โ                 โ                   โ
```

---

## Casos de Uso

### โ Caso 1: Primer Pedido
```
Usuario nuevo registrado
  โ
No tiene direcciรณn en perfil
  โ
Completa direcciรณn en checkout
  โ
Se guarda en:
  โข localStorage (inmediato)
  โข MongoDB (via API)
  โข Se asocia con la orden
  โ
Prรณxima compra: direcciรณn precargada
```

### โ Caso 2: Cambio de Direcciรณn
```
Usuario con historial
  โ
Tiene direcciรณn guardada: "Calle Vieja 1"
  โ
En checkout cambia a: "Calle Nueva 2"
  โ
Actualizaciรณn automรกtica:
  โข Perfil actualizado
  โข Orden creada con nueva direcciรณn
  โ
Prรณxima compra: "Calle Nueva 2" aparece
```

### โ Caso 3: Usuario No Autenticado
```
Intenta ir a checkout
  โ
ProtectedRoute detecta: isAuthenticated = false
  โ
Redirige a /login
  โ
Guarda origen: state = { from: '/checkout' }
  โ
Despuรฉs de login exitoso:
  navigate(from) โ va directo a checkout
```

---

**Fecha:** 12 de diciembre de 2025  
**Sistema:** Gaddyel E-commerce  
**Versiรณn:** 2.0 - Checkout Protegido
